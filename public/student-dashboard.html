<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard - EduMood</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<nav class="bg-white shadow-lg">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16">
      <div class="flex items-center">
        <div class="flex-shrink-0 flex items-center">
          <i data-feather="smile" class="h-8 w-8 text-indigo-600"></i>
          <span class="ml-2 text-xl font-bold text-gray-800">EduMood</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-gray-600" id="welcomeName">Welcome, Student!</span>
        <button onclick="logout()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">Logout</button>
      </div>
    </div>
  </div>
</nav>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Mood Submission d -->
  <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
    <h2 class="text-2xl font-bold mb-6">How are you feeling?</h2>
    <form id="moodForm">
      <div class="mb-4">
        <label>Class</label>
        <select id="classSelect" required class="w-full border px-4 py-2 rounded-lg"></select>
      </div>

      <div class="mb-4">
        <label>Mood Level</label>
        <div class="grid grid-cols-4 gap-2 mt-2">
          <button type="button" class="p-3 bg-green-100 text-green-700 rounded-lg" data-value="5"><i data-feather="smile"></i></button>
          <button type="button" class="p-3 bg-blue-100 text-blue-700 rounded-lg" data-value="4"><i data-feather="meh"></i></button>
          <button type="button" class="p-3 bg-yellow-100 text-yellow-700 rounded-lg" data-value="3"><i data-feather="frown"></i></button>
          <button type="button" class="p-3 bg-red-100 text-red-700 rounded-lg" data-value="1"><i data-feather="alert-circle"></i></button>
        </div>
        <input type="hidden" id="moodValue" required>
      </div>

      <div class="mb-6">
        <label>Notes (Optional)</label>
        <textarea id="notes" class="w-full border px-4 py-2 rounded-lg" rows="3" placeholder="What's on your mind?"></textarea>
      </div>

      <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Submit Mood</button>
    </form>
  </div>

  <!-- Mood History Chart -->
  <div class="bg-white p-6 rounded-xl shadow-sm">
    <h2 class="text-2xl font-bold mb-6">Your Mood History</h2>
    <div class="h-64">
      <canvas id="moodChart"></canvas>
    </div>
  </div>

</div>

<script>
// --- API Helper ---
async function apiRequest(url, method="GET", body=null){
  const options={method, headers:{"Content-Type":"application/json"}};
  if(body) options.body=JSON.stringify(body);
  const res=await fetch(url, options);
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

function logout(){
  apiRequest('/api/auth/logout','POST').finally(()=>window.location.href='index.html');
}

let selectedMood = null;

// Load student info and classes
async function loadStudentDashboard() {
  try{
    const student = await apiRequest('/api/student/me');
    document.getElementById('welcomeName').textContent = `Welcome, ${student.email}`;
    const classSelect = document.getElementById('classSelect');
    classSelect.innerHTML = '<option value="">Select a class</option>';
    student.selectedClasses.forEach(c=>{
      const option = document.createElement('option');
      option.value=c.className;
      option.dataset.period = c.period || '';
      option.dataset.teacher = c.teacherEmail || '';
      option.textContent = `${c.className} (${c.period || 'No Period'})`;
      classSelect.appendChild(option);
    });
    loadMoodHistory();
  } catch(err){ console.error(err); alert('Failed to load student data'); }
}

// Mood button selection
document.querySelectorAll('#moodForm button[data-value]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#moodForm button[data-value]').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
    btn.classList.add('bg-indigo-600','text-white');
    selectedMood = btn.dataset.value;
    document.getElementById('moodValue').value = selectedMood;
  });
});

// Submit mood
document.getElementById('moodForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const className = document.getElementById('classSelect').value;
  const moodLevel = document.getElementById('moodValue').value;
  const notes = document.getElementById('notes').value;
  if(!className || !moodLevel) return alert("Select class and mood");

  try{
    await apiRequest('/api/moods','POST',{className, moodLevel, notes});
    alert('Mood submitted!');
    document.getElementById('moodForm').reset();
    selectedMood = null;
    document.querySelectorAll('#moodForm button[data-value]').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
    loadMoodHistory();
  } catch(err){ console.error(err); alert('Failed to submit mood'); }
});

// Load mood history
async function loadMoodHistory(){
  try{
    const moods = await apiRequest('/api/moods');
    const labels = moods.map(m=>new Date(m.date).toLocaleDateString());
    const data = moods.map(m=>m.moodLevel);

    moodChart.data.labels = labels;
    moodChart.data.datasets[0].data = data;
    moodChart.update();
  } catch(err){ console.error(err); }
}

// Initialize Chart
const ctx = document.getElementById('moodChart').getContext('2d');
const moodChart = new Chart(ctx,{
  type:'line',
  data:{labels:[],datasets:[{label:'Mood Score',data:[],borderColor:'#4f46e5',backgroundColor:'rgba(79,70,229,0.1)',tension:0.4,fill:true}]},
  options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:5}}}
});

window.addEventListener('DOMContentLoaded', ()=>{ feather.replace(); loadStudentDashboard(); AOS.init(); });
</script>
</body>
</html>

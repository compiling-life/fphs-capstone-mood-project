<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - EduMood</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i data-feather="smile" class="h-8 w-8 text-indigo-600"></i>
                        <span class="ml-2 text-xl font-bold text-gray-800">EduMood</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">Welcome, Teacher!</span>
                    <button onclick="logout()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8" id="overviewCards">
            <!-- Dynamically filled -->
        </div>

        <!-- Class Comparison Chart -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm" data-aos="fade-right">
                <h2 class="text-2xl font-bold mb-6">Class Mood Comparison</h2>
                <div class="h-64">
                    <canvas id="classChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm" data-aos="fade-left">
                <h2 class="text-2xl font-bold mb-6">Weekly Trends</h2>
                <div class="h-64">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8" data-aos="fade-up" id="aiInsights">
            <!-- Dynamically filled -->
        </div>

        <!-- Recent Submissions Table -->
        <div class="bg-white p-6 rounded-xl shadow-sm" data-aos="fade-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Recent Submissions</h2>
                <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center" id="exportBtn">
                    <i data-feather="download" class="mr-2"></i>
                    Export Report
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="recentSubmissionsTable">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3">Date</th>
                            <th class="text-left py-3">Class</th>
                            <th class="text-left py-3">Mood Level</th>
                            <th class="text-left py-3">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function apiRequest(url, method = "GET", body = null) {
            const options = { method, headers: { "Content-Type": "application/json" } };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }
        
        // Logout
        function logout() {
            apiRequest('/api/auth/logout', 'POST').finally(() => {
                window.location.href = 'index.html';
            });
        }
        
        // Load moods for teacher
        async function loadTeacherMoods() {
            try {
                const moods = await apiRequest('/api/moods');
        
                // Prepare chart data
                const classes = [...new Set(moods.map(m => m.className))];
                const avgMoodPerClass = classes.map(cls => {
                    const clsMoods = moods.filter(m => m.className === cls);
                    const avg = clsMoods.reduce((sum, m) => sum + m.moodLevel, 0) / clsMoods.length;
                    return avg;
                });
        
                classChart.data.labels = classes;
                classChart.data.datasets[0].data = avgMoodPerClass;
                classChart.update();
        
                // Weekly trend data
                const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                const trendDataSets = classes.map((cls, idx) => {
                    const clsMoods = weekdays.map(day => {
                        const dayMoods = moods.filter(m => new Date(m.date).toLocaleDateString('en-US', { weekday: 'short' }) === day && m.className === cls);
                        if (dayMoods.length === 0) return null;
                        return dayMoods.reduce((sum, m) => sum + m.moodLevel, 0) / dayMoods.length;
                    });
                    const colorPalette = ['#ef4444','#3b82f6','#a855f7','#10b981','#f59e0b'];
                    return {
                        label: cls,
                        data: trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data || trendDataSets[idx]?.data,
                        borderColor: colorPalette[idx % colorPalette.length],
                        tension: 0.4
                    };
                });
        
                trendChart.data.datasets = trendDataSets;
                trendChart.update();
        
                // Populate recent submissions table
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';
                moods.reverse().forEach(m => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="py-3">${new Date(m.date).toLocaleString()}</td>
                        <td class="py-3">${m.className}</td>
                        <td class="py-3"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-sm">${m.moodLevel}</span></td>
                        <td class="py-3">${m.notes || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
        
            } catch (err) {
                console.error(err);
            }
        }
        
        // Initialize charts
        const classCtx = document.getElementById('classChart').getContext('2d');
        const classChart = new Chart(classCtx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Average Mood Score', data: [], backgroundColor: [] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 5 } } }
        });
        
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const trendChart = new Chart(trendCtx, {
            type: 'line',
            data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets: [] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 5 } } }
        });
        
        // Initial load
        loadTeacherMoods();
        
        AOS.init();
        feather.replace();
        </script>
        
</body>
</html>
